<%- include('layout', { title: 'Session - Claude Viewer', body: `
<div class="session-page">
  <aside class="session-sidebar" id="sessionSidebar">
    <div class="sidebar-header">
      <a href="/" class="back-link">&larr; All sessions</a>
      <h3 class="sidebar-title" id="sidebarTitle">Project sessions</h3>
    </div>
    <nav class="session-nav" id="sessionNav">
      <div class="loading">Loading...</div>
    </nav>
  </aside>

  <div class="session-main">
    <div class="session-viewer">
      <div class="session-header" id="sessionHeader">
        <div class="loading">Loading session...</div>
      </div>

      <div id="conversation" class="conversation">
        <div class="loading">Loading messages...</div>
      </div>
    </div>
  </div>

  <aside class="agent-sidebar" id="agentSidebar" style="display: none;">
    <div class="sidebar-header">
      <h3 class="sidebar-title">Agent Sessions</h3>
    </div>
    <div id="hierarchySection" class="hierarchy-content">
      <!-- Parent/children links will be inserted here -->
    </div>
  </aside>
</div>

<!-- File preview modal -->
<div id="filePreviewModal" class="modal" style="display: none;">
  <div class="modal-backdrop" onclick="closeFilePreview()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-title" id="modalFileName"></span>
      <button class="modal-close" onclick="closeFilePreview()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody">
      <iframe id="previewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
  </div>
</div>

<script src="/js/renderer.js"></script>
<script>
const sessionId = '${sessionId}';
const projectId = '${projectId}';

function formatRelativeTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return diffMins + ' minute' + (diffMins !== 1 ? 's' : '') + ' ago';
  if (diffHours < 24) return diffHours + ' hour' + (diffHours !== 1 ? 's' : '') + ' ago';
  if (diffDays < 7) return diffDays + ' day' + (diffDays !== 1 ? 's' : '') + ' ago';

  const options = { month: 'long', day: 'numeric' };
  if (date.getFullYear() !== now.getFullYear()) {
    options.year = 'numeric';
  }
  return date.toLocaleDateString('en-US', options);
}

function truncateTitle(text, maxLength = 80) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength).trim() + '...';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getFirstMessage(session) {
  const firstUserMsg = session.conversation.find(m => m.type === 'user');
  if (!firstUserMsg) return null;
  const textBlock = firstUserMsg.content.find(b => b.type === 'text');
  return textBlock?.text || null;
}

let cachedProjectSessions = [];

document.addEventListener('DOMContentLoaded', () => {
  loadSession();
  if (projectId) {
    loadProjectSessions();
    loadHierarchy();
  } else {
    document.getElementById('sessionSidebar').style.display = 'none';
  }
});

async function loadHierarchy() {
  const sidebar = document.getElementById('agentSidebar');
  const section = document.getElementById('hierarchySection');
  const isAgentSession = sessionId.startsWith('agent-');

  try {
    if (isAgentSession) {
      // Load parent session
      const res = await fetch('/api/sessions/' + encodeURIComponent(sessionId) + '/parent?project=' + encodeURIComponent(projectId));
      const data = await res.json();

      if (data.parent) {
        sidebar.style.display = 'flex';
        section.innerHTML = \`
          <div class="hierarchy-group">
            <div class="hierarchy-label">Parent Session</div>
            <a href="/session/\${data.parent.id}?project=\${projectId}" class="hierarchy-link parent-link">
              <span class="hierarchy-icon">↑</span>
              <span class="hierarchy-title">\${escapeHtml(truncateTitle(data.parent.firstMessage, 50) || data.parent.slug || data.parent.id.slice(0, 8))}</span>
            </a>
          </div>
        \`;
      }
    } else {
      // Load children sessions
      const res = await fetch('/api/sessions/' + encodeURIComponent(sessionId) + '/children?project=' + encodeURIComponent(projectId));
      const data = await res.json();

      if (data.children && data.children.length > 0) {
        sidebar.style.display = 'flex';
        section.innerHTML = \`
          <div class="hierarchy-group">
            <div class="hierarchy-label">Spawned Agents (\${data.children.length})</div>
            \${data.children.map(child => \`
              <a href="/session/\${child.id}?project=\${projectId}" class="hierarchy-link child-link">
                <span class="hierarchy-icon">→</span>
                <span class="hierarchy-title">\${escapeHtml(truncateTitle(child.firstMessage, 50) || child.slug || child.id)}</span>
              </a>
            \`).join('')}
          </div>
        \`;
      }
    }
  } catch (err) {
    // Silently fail - hierarchy is optional
    console.error('Failed to load hierarchy:', err);
  }
}

async function loadSession() {
  try {
    let url = '/api/sessions/' + sessionId;
    if (projectId) url += '?project=' + encodeURIComponent(projectId);

    const res = await fetch(url);
    if (!res.ok) throw new Error('Session not found');

    const session = await res.json();
    renderSessionHeader(session);
    renderConversation(session);

    // Update sidebar title with project name
    if (session.project?.name) {
      document.getElementById('sidebarTitle').textContent = session.project.name;
    }
  } catch (err) {
    document.getElementById('sessionHeader').innerHTML =
      '<div class="error">Failed to load session: ' + err.message + '</div>';
    document.getElementById('conversation').innerHTML = '';
  }
}

async function loadProjectSessions() {
  try {
    const res = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/sessions?excludeAgents=true');
    const sessions = await res.json();
    cachedProjectSessions = sessions;
    renderSessionNav(sessions);
  } catch (err) {
    document.getElementById('sessionNav').innerHTML =
      '<div class="error">Failed to load sessions</div>';
  }
}

function renderSessionNav(sessions) {
  const nav = document.getElementById('sessionNav');

  if (sessions.length === 0) {
    nav.innerHTML = '<div class="empty">No sessions</div>';
    return;
  }

  nav.innerHTML = sessions.map(s => {
    const isActive = s.id === sessionId;
    const title = truncateTitle(s.firstMessage, 80) || s.slug || s.id.slice(0, 8);
    const relativeTime = formatRelativeTime(s.timestamp);

    return \`
      <a href="/session/\${s.id}?project=\${projectId}"
         class="session-nav-item \${isActive ? 'active' : ''}">
        <span class="nav-item-title">\${escapeHtml(title)}</span>
        <div class="nav-item-meta">
          <span class="nav-item-slug">\${s.slug || ''}</span>
          <span class="nav-item-date">\${relativeTime}</span>
        </div>
      </a>
    \`;
  }).join('');
}

function renderSessionHeader(session) {
  const header = document.getElementById('sessionHeader');
  const firstMessage = getFirstMessage(session);
  const title = truncateTitle(firstMessage, 100) || session.slug || session.id;
  const relativeTime = formatRelativeTime(session.metadata.startTime);

  header.innerHTML = \`
    <h1 class="session-title">\${escapeHtml(title)}</h1>
    <div class="session-slug-subtitle">\${session.slug || session.id}</div>
    <div class="session-meta-row">
      <span class="meta-item">\${relativeTime}</span>
      <span class="meta-item"><strong>Branch:</strong> \${session.metadata.gitBranch || 'N/A'}</span>
      <span class="meta-item"><strong>Version:</strong> \${session.metadata.version || 'N/A'}</span>
    </div>
    <div class="session-stats">
      <span>\${session.stats.userMessages} user messages</span>
      <span>\${session.stats.assistantMessages} assistant messages</span>
      <span>\${session.stats.toolCalls} tool calls</span>
    </div>
    <div class="resume-command">
      <code id="resumeCmd">claude --resume \${session.id}</code>
      <button class="copy-btn" onclick="copyResume()">Copy</button>
    </div>
  \`;
}

function copyResume() {
  const cmd = document.getElementById('resumeCmd').textContent;
  navigator.clipboard.writeText(cmd).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

function renderConversation(session) {
  const container = document.getElementById('conversation');
  const renderer = new MessageRenderer();

  // Try main conversation first, fall back to all messages (for agent sessions)
  let messages = session.conversation.filter(m => !m.isSidechain);
  if (messages.length === 0) {
    messages = session.conversation;
  }

  if (messages.length === 0) {
    container.innerHTML = '<div class="empty">No messages in this session</div>';
    return;
  }

  container.innerHTML = '';
  for (const msg of messages) {
    container.appendChild(renderer.renderMessage(msg));
  }

  // Apply syntax highlighting to all code blocks
  document.querySelectorAll('pre code').forEach(block => {
    hljs.highlightElement(block);
  });
}

function openFilePreview(filePath) {
  const fileName = filePath.split('/').pop();
  const modal = document.getElementById('filePreviewModal');
  const frame = document.getElementById('previewFrame');
  const title = document.getElementById('modalFileName');

  title.textContent = fileName;
  frame.src = '/api/preview-file?path=' + encodeURIComponent(filePath);
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeFilePreview() {
  const modal = document.getElementById('filePreviewModal');
  const frame = document.getElementById('previewFrame');

  modal.style.display = 'none';
  frame.src = '';
  document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeFilePreview();
});
</script>
`}) %>
