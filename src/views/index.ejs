<%- include('layout', { title: 'Claude Session Viewer', body: `
<div class="session-browser">
  <div class="browser-header">
    <h1>Sessions</h1>
    <div class="stats" id="stats"></div>
  </div>

  <div class="filter-bar">
    <select id="projectFilter" class="filter-select">
      <option value="">All Projects</option>
    </select>
    <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
  </div>

  <div id="sessionList" class="session-list">
    <div class="loading">Loading sessions...</div>
  </div>

  <div id="loadMore" class="load-more"></div>
</div>

<script>
function formatRelativeTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return diffMins + ' minute' + (diffMins !== 1 ? 's' : '') + ' ago';
  if (diffHours < 24) return diffHours + ' hour' + (diffHours !== 1 ? 's' : '') + ' ago';
  if (diffDays < 7) return diffDays + ' day' + (diffDays !== 1 ? 's' : '') + ' ago';

  const options = { month: 'long', day: 'numeric' };
  if (date.getFullYear() !== now.getFullYear()) {
    options.year = 'numeric';
  }
  return date.toLocaleDateString('en-US', options);
}

function truncateTitle(text, maxLength = 80) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength).trim() + '...';
}

document.addEventListener('DOMContentLoaded', () => {
  loadProjects();

  // Check for search query in URL
  const urlParams = new URLSearchParams(window.location.search);
  const searchQuery = urlParams.get('q');
  const searchInput = document.getElementById('searchInput');

  if (searchQuery) {
    // Pre-fill search input and perform search
    searchInput.value = searchQuery;
    performSearch(searchQuery);
  } else {
    loadSessions();
  }

  searchInput.addEventListener('input', debounce(handleSearch, 300));
  document.getElementById('projectFilter').addEventListener('change', loadSessions);
  document.getElementById('refreshBtn').addEventListener('click', () => {
    // Clear search when refreshing
    searchInput.value = '';
    window.history.replaceState({}, '', '/');
    loadSessions();
  });
});

let currentPage = 1;
let totalPages = 1;
let totalSessions = 0;
let isLoading = false;
let allLoaded = false;
let currentProjectFilter = '';

// Intersection Observer for infinite scroll
let scrollObserver = null;

function setupScrollObserver() {
  if (scrollObserver) scrollObserver.disconnect();

  const loadMoreEl = document.getElementById('loadMore');
  scrollObserver = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting && !isLoading && !allLoaded && !currentProjectFilter) {
      loadMoreSessions();
    }
  }, { rootMargin: '200px' });

  scrollObserver.observe(loadMoreEl);
}

async function loadSessions(reset = true) {
  if (reset) {
    currentPage = 1;
    allLoaded = false;
    document.getElementById('sessionList').innerHTML = '<div class="loading">Loading sessions...</div>';
  }

  currentProjectFilter = document.getElementById('projectFilter').value;
  const container = document.getElementById('sessionList');
  isLoading = true;
  updateLoadMoreIndicator();

  try {
    let sessions;

    if (currentProjectFilter) {
      // Fetch all sessions for specific project (no pagination needed)
      const res = await fetch('/api/projects/' + encodeURIComponent(currentProjectFilter) + '/sessions?excludeAgents=true');
      const projectSessions = await res.json();
      const projectName = document.getElementById('projectFilter').selectedOptions[0].textContent.split(' (')[0];
      sessions = projectSessions.map(s => ({
        ...s,
        project: projectName,
        projectId: currentProjectFilter
      }));
      totalSessions = sessions.length;
      totalPages = 1;
      allLoaded = true;
    } else {
      // Fetch paginated sessions
      const res = await fetch('/api/sessions?page=' + currentPage + '&limit=30&excludeAgents=true');
      const data = await res.json();
      sessions = data.sessions;
      totalSessions = data.total;
      totalPages = data.pages;
      allLoaded = currentPage >= totalPages;
    }

    if (reset) {
      renderSessions(sessions);
    } else {
      appendSessions(sessions);
    }

    document.getElementById('stats').textContent = totalSessions + ' sessions';
    isLoading = false;
    updateLoadMoreIndicator();
    setupScrollObserver();
  } catch (err) {
    container.innerHTML = '<div class="error">Failed to load sessions</div>';
    isLoading = false;
    updateLoadMoreIndicator();
  }
}

async function loadMoreSessions() {
  if (isLoading || allLoaded || currentProjectFilter) return;
  currentPage++;
  await loadSessions(false);
}

function updateLoadMoreIndicator() {
  const loadMoreEl = document.getElementById('loadMore');
  if (isLoading) {
    loadMoreEl.innerHTML = '<div class="loading-more">Loading more...</div>';
  } else if (allLoaded && totalSessions > 0) {
    loadMoreEl.innerHTML = '<div class="all-loaded">All sessions loaded</div>';
  } else {
    loadMoreEl.innerHTML = '';
  }
}

async function loadProjects() {
  try {
    const res = await fetch('/api/projects');
    const projects = await res.json();
    const select = document.getElementById('projectFilter');

    projects.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name + ' (' + p.sessionCount + ')';
      select.appendChild(opt);
    });
  } catch (err) {}
}

function renderSessionCard(s) {
  const title = truncateTitle(s.firstMessage, 80) || s.slug || s.id;
  const relativeTime = formatRelativeTime(s.timestamp);
  const expandButton = s.hasAgentChildren ? \`
    <button class="expand-children-btn" onclick="toggleChildren(event, '\${s.id}', '\${s.projectId}')" title="Show agent sessions">
      <span class="expand-icon">▶</span>
    </button>
  \` : '';

  return \`
    <div class="session-wrapper" data-session-id="\${s.id}">
      <a href="/session/\${s.id}?project=\${s.projectId}" class="session-card">
        <div class="session-top">
          <span class="session-title">\${escapeHtml(title)}</span>
          <span class="session-date">\${relativeTime}</span>
        </div>
        <div class="session-meta">
          <span class="session-slug">\${s.slug || ''}</span>
          <span class="session-project">\${s.project}</span>
        </div>
      </a>
      \${expandButton}
      <div class="session-children" id="children-\${s.id}" style="display: none;"></div>
    </div>
  \`;
}

function renderSessions(sessions) {
  const container = document.getElementById('sessionList');

  if (sessions.length === 0) {
    container.innerHTML = '<div class="empty">No sessions found</div>';
    return;
  }

  container.innerHTML = sessions.map(renderSessionCard).join('');
}

function appendSessions(sessions) {
  const container = document.getElementById('sessionList');
  const html = sessions.map(renderSessionCard).join('');
  container.insertAdjacentHTML('beforeend', html);
}

// Track expanded sessions
const expandedSessions = new Set();

async function toggleChildren(event, sessionId, projectId) {
  event.preventDefault();
  event.stopPropagation();

  const wrapper = document.querySelector(\`[data-session-id="\${sessionId}"]\`);
  const childrenContainer = document.getElementById('children-' + sessionId);
  const expandBtn = wrapper.querySelector('.expand-children-btn');
  const expandIcon = expandBtn.querySelector('.expand-icon');

  if (expandedSessions.has(sessionId)) {
    // Collapse
    expandedSessions.delete(sessionId);
    childrenContainer.style.display = 'none';
    expandIcon.textContent = '▶';
    expandBtn.classList.remove('expanded');
  } else {
    // Expand and load children
    expandedSessions.add(sessionId);
    expandIcon.textContent = '▼';
    expandBtn.classList.add('expanded');
    childrenContainer.style.display = 'block';
    childrenContainer.innerHTML = '<div class="loading-children">Loading agent sessions...</div>';

    try {
      const res = await fetch('/api/sessions/' + encodeURIComponent(sessionId) + '/children?project=' + encodeURIComponent(projectId));
      const data = await res.json();

      if (data.children && data.children.length > 0) {
        childrenContainer.innerHTML = data.children.map(child => {
          const title = truncateTitle(child.firstMessage, 60) || child.slug || child.id;
          const relativeTime = formatRelativeTime(child.timestamp);
          return \`
            <a href="/session/\${child.id}?project=\${child.projectId}" class="session-card child-session agent-session">
              <div class="session-top">
                <span class="session-title">\${escapeHtml(title)}</span>
                <span class="session-date">\${relativeTime}</span>
              </div>
              <div class="session-meta">
                <span class="session-slug">\${child.slug || ''} <span class="agent-badge">agent</span></span>
              </div>
            </a>
          \`;
        }).join('');
      } else {
        childrenContainer.innerHTML = '<div class="no-children">No agent sessions</div>';
      }
    } catch (err) {
      childrenContainer.innerHTML = '<div class="error">Failed to load agent sessions</div>';
    }
  }
}

function handleSearch(e) {
  const query = e.target.value.trim();
  if (query.length < 2) {
    // Clear URL search param when search is cleared
    window.history.replaceState({}, '', '/');
    loadSessions();
    return;
  }
  performSearch(query);
}

async function performSearch(query) {
  // Update URL with search query (without page reload)
  window.history.replaceState({}, '', '/?q=' + encodeURIComponent(query));

  // Clear project filter when searching (search is global)
  document.getElementById('projectFilter').value = '';

  // Reset infinite scroll state
  allLoaded = true;
  currentProjectFilter = '';

  const container = document.getElementById('sessionList');
  container.innerHTML = '<div class="loading">Searching...</div>';

  try {
    const res = await fetch('/api/search?q=' + encodeURIComponent(query) + '&excludeAgents=true');
    const data = await res.json();
    renderSessions(data.results);
    document.getElementById('stats').textContent = data.results.length + ' results';
    document.getElementById('loadMore').innerHTML = '';
  } catch (err) {
    container.innerHTML = '<div class="error">Search failed</div>';
  }
}

function debounce(fn, ms) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => fn.apply(this, args), ms);
  };
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
`}) %>
